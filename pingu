#!/usr/bin/env bash

# uses bc, bash arith, printf, trap, date, tr, curl
# remove bc, bash arith, 
# hmm no bc so no duration stuff

fmt_diff() {
    min=$(( $1 / 60 ))
    sec=$(( $1 % 60 ))
    (( min == 0 )) && (( sec == 0 )) && printf "less than a second"
    (( min == 1 )) && printf "${min} minute "
    (( min > 1 )) && printf "${min} minutes "
    (( sec == 1 )) && printf "${sec} second"
    (( sec > 1 )) && printf "${sec} seconds"
}

trap : INT TERM QUIT

source ~/.pingurc

start=$(date +%s)
command=$*
"$@"
status=$?
diff=$(echo "$(date +%s) - ${start}" | bc)
if [[ ${status} -eq 0 ]]; then
    color="good"
    text=":white_check_mark: All good!\nTook $(fmt_diff "${diff}")."
else
    color="danger"
    text=":x: Exited with code ${status}\nTook $(fmt_diff "${diff}")."
fi

echo " 
{
    'username': 'pingu', 
    'channel': '${channel}',
    'icon_emoji': ':penguin:',
    'attachments': [
        {
            'fallback': '${text}',
            'text': '${text}',
            'color': '${color}',
            'footer': '$(hostname)',
            'ts': '${start}',
            'fields': [
                {
                    'title': 'Command',
                    'value': '${command}',
                    'short': false
                },
                {
                    'title': 'Directory',
                    'value': '$(pwd)',
                    'short': false
                }
            ]
        }
    ]
}
" | tr "'" '"' | curl -sSLd @- "${webhook}" > /dev/null

exit ${status}
