#!/usr/bin/env bash

fmt_diff() {
    min=$(( $1 / 60 ))
    sec=$(( $1 % 60 ))
    if [[ ${min} -eq 0 ]]; then
        echo "${sec} sec"
    else
        echo "${min} min ${sec} sec"
    fi
}

source ~/.pingurc

start=$(date +%s)
command=$*
"$@"
status=$?
diff=$(echo "$(date +%s) - ${start}" | bc)
if [[ ${status} -eq 0 ]]; then
    color="good"
    text=":white_check_mark: All good! :ok_hand: ($(fmt_diff "${diff}"))"
else
    color="danger"
    text=":x: Exited with code ${status}... :thinking_face: ($(fmt_diff "${diff}"))"
fi

echo " 
{
    'username': 'pingu', 
    'channel': '${channel}',
    'icon_emoji': ':penguin:',
    'attachments': [
        {
            'fallback': '${text}',
            'text': '${text}',
            'color': '${color}',
            'footer': '$(whoami)@$(hostname)',
            'ts': '${start}',
            'fields': [
                {
                    'title': 'Command',
                    'value': '\`${command}\`',
                    'short': false
                },
                {
                    'title': 'Directory',
                    'value': '\`$(pwd)\`',
                    'short': false
                }
            ]
        }
    ]
}
" | tr "'" '"' | curl -sSLd @- "${webhook}" > /dev/null

exit ${status}
