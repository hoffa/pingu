#!/usr/bin/env bash

SUCCESS_EMOJIS=(":+1:" ":ok_hand:" ":clap:" ":muscle:" ":man-getting-massage:" ":woman-getting-massage:" ":v:" ":the_horns:" ":raised_hands:" ":pray:" ":heart_eyes_cat:" ":relieved:" ":innocent:" ":man_dancing:" ":nail_care:" ":ocean:")
FAILURE_EMOJIS=(":thinking_face:" ":face_with_raised_eyebrow:" ":face_with_monocle:" ":poop:" ":speak_no_evil:" ":scream_cat:" ":man-shrugging:" ":woman-shrugging:" ":eyes:" ":grimacing:" ":weary:" ":face_with_hand_over_mouth:")

success_emoji=${SUCCESS_EMOJIS[$RANDOM % ${#SUCCESS_EMOJIS[@]}]}
failure_emoji=${FAILURE_EMOJIS[$RANDOM % ${#FAILURE_EMOJIS[@]}]}

fmt_diff() {
    min=$(( $1 / 60 ))
    sec=$(( $1 % 60 ))
    (( min == 0 )) && (( sec == 0 )) && printf "less than a second"
    (( min == 1 )) && printf "${min} minute "
    (( min > 1 )) && printf "${min} minutes "
    (( sec == 1 )) && printf "${sec} second"
    (( sec > 1 )) && printf "${sec} seconds"
}

trap : INT TERM QUIT

source ~/.pingurc

start=$(date +%s)
command=$*
"$@"
status=$?
diff=$(echo "$(date +%s) - ${start}" | bc)
if [[ ${status} -eq 0 ]]; then
    color="good"
    text=":white_check_mark: All good! ${success_emoji}\nTook $(fmt_diff "${diff}")."
else
    color="danger"
    text=":x: Exited with code ${status}... ${failure_emoji}\nTook $(fmt_diff "${diff}")."
fi

echo " 
{
    'username': 'pingu', 
    'channel': '${channel}',
    'icon_emoji': ':penguin:',
    'attachments': [
        {
            'fallback': '${text}',
            'text': '${text}',
            'color': '${color}',
            'footer': '$(whoami)@$(hostname)',
            'ts': '${start}',
            'fields': [
                {
                    'title': 'Command',
                    'value': '${command}',
                    'short': false
                },
                {
                    'title': 'Directory',
                    'value': '$(pwd)',
                    'short': false
                }
            ]
        }
    ]
}
" | tr "'" '"' | curl -sSLd @- "${webhook}" > /dev/null

exit ${status}
