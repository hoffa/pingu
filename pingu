#!/bin/sh

trap : INT TERM QUIT

escape() {
    echo "$1" | sed 's/"/\\"/g'
}

eval "$@"
status=$?

if [ ${status} -eq 0 ]; then
    color="good"
    emoji=":white_check_mark:"
else
    color="danger"
    emoji=":x:"
fi
text=$(escape "${emoji} \`$*\`")
fallback=$(escape "${emoji} $*")

echo '{
    "username": "pingu",
    "icon_emoji": ":penguin:",
    "attachments": [
         {
            "text": "'"${text}"'",
            "fallback": "'"${fallback}"'",
            "color": "'"${color}"'",
            "footer": "'"$(uname -n) | $(id -un)"'"
        }
    ]
}' | curl -sSLd @- "${SLACK_WEBHOOK_URL}" > /dev/null

exit ${status}
