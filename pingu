#!/usr/bin/env bash

fmt_diff() {
    min=$(( $1 / 60 ))
    sec=$(( $1 % 60 ))
    [[ ${min} -eq 0 ]] && [[ ${sec} -eq 0 ]] && printf "less than a second"
    [[ ${min} -eq 1 ]] && printf "${min} minute "
    [[ ${min} -gt 1 ]] && printf "${min} minutes "
    [[ ${sec} -eq 1 ]] && printf "${sec} second"
    [[ ${sec} -gt 1 ]] && printf "${sec} seconds"
}

trap : INT TERM QUIT

source ~/.pingurc

start=$(date +%s)
command=$*
"$@"
status=$?
diff=$(echo "$(date +%s) - ${start}" | bc)
if [[ ${status} -eq 0 ]]; then
    color="good"
    text=":white_check_mark: All good! :ok_hand:\nTook $(fmt_diff "${diff}")."
else
    color="danger"
    text=":x: Exited with code ${status}... :thinking_face:\nTook $(fmt_diff "${diff}")."
fi

echo " 
{
    'username': 'pingu', 
    'channel': '${channel}',
    'icon_emoji': ':penguin:',
    'attachments': [
        {
            'fallback': '${text}',
            'text': '${text}',
            'color': '${color}',
            'footer': '$(whoami)@$(hostname)',
            'ts': '${start}',
            'fields': [
                {
                    'title': 'Command',
                    'value': '\`${command}\`',
                    'short': false
                },
                {
                    'title': 'Directory',
                    'value': '\`$(pwd)\`',
                    'short': false
                }
            ]
        }
    ]
}
" | tr "'" '"' | curl -sSLd @- "${webhook}" > /dev/null

exit ${status}
